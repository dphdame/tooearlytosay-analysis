#!/usr/bin/env python3
"""
Vulnerability Map Creation

Author: V Cholette
Purpose: Generate choropleth map of vulnerability index

Inputs:
- Vulnerability index GeoJSON (from script 02)

Outputs:
- Choropleth map (PNG)

Usage:
    python 03_create_vulnerability_map.py
"""

import geopandas as gpd
import matplotlib.pyplot as plt
import matplotlib.colors as mcolors
from pathlib import Path

# ============================================================================
# Configuration
# ============================================================================

PROJECT_ROOT = Path(__file__).parent.parent
DATA_DIR = PROJECT_ROOT / "data"
OUTPUT_DIR = PROJECT_ROOT / "outputs"
OUTPUT_DIR.mkdir(parents=True, exist_ok=True)

INPUT_FILE = DATA_DIR / "processed" / "vulnerability_index.geojson"
OUTPUT_FILE = OUTPUT_DIR / "vulnerability_map.png"

# Color scheme (red = high vulnerability)
COLORS = ['#2166ac', '#67a9cf', '#f7f7f7', '#ef8a62', '#b2182b']
QUINTILE_LABELS = ['Q1 (Lowest)', 'Q2 (Low)', 'Q3 (Medium)', 'Q4 (High)', 'Q5 (Highest)']


# ============================================================================
# Map Creation
# ============================================================================

def create_vulnerability_map(gdf, output_path):
    """Create choropleth map of vulnerability index."""

    fig, ax = plt.subplots(1, 1, figsize=(12, 10))

    # Create colormap
    cmap = mcolors.LinearSegmentedColormap.from_list('vulnerability', COLORS)

    # Plot choropleth
    gdf.plot(
        column='vulnerability_index',
        cmap=cmap,
        linewidth=0.2,
        edgecolor='white',
        legend=True,
        legend_kwds={
            'label': 'Vulnerability Index',
            'orientation': 'horizontal',
            'shrink': 0.6,
            'pad': 0.05
        },
        ax=ax
    )

    # Styling
    ax.set_title('Food Insecurity Vulnerability Index\nSanta Clara County Census Tracts',
                 fontsize=14, fontweight='bold', pad=20)
    ax.set_axis_off()

    # Add data source
    fig.text(0.5, 0.02,
             'Data: ACS 5-Year Estimates (2019-2023) | Census TIGER/Line Shapefiles',
             ha='center', fontsize=9, color='gray')

    plt.tight_layout()
    plt.savefig(output_path, dpi=150, bbox_inches='tight', facecolor='white')
    plt.close()

    print(f"✓ Map saved: {output_path}")


def create_quintile_map(gdf, output_path):
    """Create categorical map by quintile."""

    fig, ax = plt.subplots(1, 1, figsize=(12, 10))

    # Map quintiles to colors
    quintile_colors = {
        'Q1_Lowest': COLORS[0],
        'Q2_Low': COLORS[1],
        'Q3_Medium': COLORS[2],
        'Q4_High': COLORS[3],
        'Q5_Highest': COLORS[4]
    }

    gdf['color'] = gdf['vulnerability_quintile'].map(quintile_colors)

    # Plot
    gdf.plot(
        color=gdf['color'],
        linewidth=0.2,
        edgecolor='white',
        ax=ax
    )

    # Legend
    from matplotlib.patches import Patch
    legend_elements = [
        Patch(facecolor=COLORS[i], label=QUINTILE_LABELS[i])
        for i in range(5)
    ]
    ax.legend(handles=legend_elements, loc='lower right', title='Vulnerability Quintile')

    # Styling
    ax.set_title('Food Insecurity Vulnerability by Quintile\nSanta Clara County Census Tracts',
                 fontsize=14, fontweight='bold', pad=20)
    ax.set_axis_off()

    plt.tight_layout()

    output_quintile = output_path.parent / "vulnerability_map_quintiles.png"
    plt.savefig(output_quintile, dpi=150, bbox_inches='tight', facecolor='white')
    plt.close()

    print(f"✓ Quintile map saved: {output_quintile}")


# ============================================================================
# Main
# ============================================================================

def main():
    print("=" * 60)
    print("VULNERABILITY MAP CREATION")
    print("=" * 60)

    # Load data
    if not INPUT_FILE.exists():
        raise FileNotFoundError(
            f"Input file not found: {INPUT_FILE}\n"
            "Run script 02_calculate_vulnerability_index.py first."
        )

    print(f"\nLoading: {INPUT_FILE}")
    gdf = gpd.read_file(INPUT_FILE)
    print(f"Loaded {len(gdf)} tracts")

    # Create maps
    print("\nCreating maps...")
    create_vulnerability_map(gdf, OUTPUT_FILE)
    create_quintile_map(gdf, OUTPUT_FILE)

    print("\n" + "=" * 60)
    print("COMPLETE")
    print("=" * 60)


if __name__ == "__main__":
    main()
